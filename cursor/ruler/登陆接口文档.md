# 用户认证功能接口文档

## 1. 数据库表结构

### 1.1 用户信息表

```sql
DROP TABLE IF EXISTS users;
CREATE TABLE users (
    id bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
    username varchar(50) NOT NULL COMMENT '用户名',
    email varchar(100) NOT NULL COMMENT '邮箱地址',
    password varchar(255) NOT NULL COMMENT '密码哈希值',
    salt varchar(32) NOT NULL COMMENT '密码盐值',
    nickname varchar(50) DEFAULT NULL COMMENT '昵称',
    avatar varchar(255) DEFAULT NULL COMMENT '头像URL',
    phone varchar(20) DEFAULT NULL COMMENT '手机号',
    gender tinyint(1) DEFAULT 0 COMMENT '性别，0-未知 1-男 2-女',
    birthday date DEFAULT NULL COMMENT '生日',
    last_login_time datetime DEFAULT NULL COMMENT '最后登录时间',
    last_login_ip varchar(50) DEFAULT NULL COMMENT '最后登录IP',
    login_count int(11) DEFAULT 0 COMMENT '登录次数',
    status tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态，0-禁用，1-正常',
    email_verified tinyint(1) DEFAULT 0 COMMENT '邮箱是否已验证，0-未验证 1-已验证',
    create_dt datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_dt datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (id),
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_email (email),
    INDEX idx_status (status),
    INDEX idx_last_login_time (last_login_time),
    INDEX idx_create_dt (create_dt)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COMMENT = '用户信息表';
```

### 1.2 邮箱验证码表

```sql
DROP TABLE IF EXISTS email_verifications;
CREATE TABLE email_verifications (
    id bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
    email varchar(100) NOT NULL COMMENT '邮箱地址',
    verification_code varchar(10) NOT NULL COMMENT '验证码',
    verification_type tinyint(2) NOT NULL COMMENT '验证类型，1-注册验证 2-密码重置 3-登录验证',
    is_used tinyint(1) DEFAULT 0 COMMENT '是否已使用，0-未使用 1-已使用',
    expire_time datetime NOT NULL COMMENT '过期时间',
    send_count int(11) DEFAULT 1 COMMENT '发送次数',
    ip_address varchar(50) DEFAULT NULL COMMENT '发送IP地址',
    user_agent varchar(500) DEFAULT NULL COMMENT '用户代理',
    create_dt datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_dt datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (id),
    INDEX idx_email_type (email, verification_type),
    INDEX idx_expire_time (expire_time),
    INDEX idx_create_dt (create_dt)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COMMENT = '邮箱验证码表';
```

### 1.3 用户会话表

```sql
DROP TABLE IF EXISTS user_sessions;
CREATE TABLE user_sessions (
    id bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
    user_id bigint(20) NOT NULL COMMENT '用户ID',
    session_id varchar(128) NOT NULL COMMENT '会话ID',
    access_token varchar(255) NOT NULL COMMENT '访问令牌',
    refresh_token varchar(255) DEFAULT NULL COMMENT '刷新令牌',
    device_type varchar(50) DEFAULT NULL COMMENT '设备类型',
    device_id varchar(100) DEFAULT NULL COMMENT '设备标识',
    ip_address varchar(50) DEFAULT NULL COMMENT 'IP地址',
    user_agent varchar(500) DEFAULT NULL COMMENT '用户代理',
    login_time datetime DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
    last_active_time datetime DEFAULT CURRENT_TIMESTAMP COMMENT '最后活跃时间',
    expire_time datetime NOT NULL COMMENT '过期时间',
    status tinyint(1) DEFAULT 1 COMMENT '状态，0-已失效 1-有效',
    PRIMARY KEY (id),
    UNIQUE KEY uk_session_id (session_id),
    UNIQUE KEY uk_access_token (access_token),
    INDEX idx_user_id (user_id),
    INDEX idx_expire_time (expire_time),
    INDEX idx_status (status)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COMMENT = '用户会话表';
```

## 2. API 接口详细说明

### 2.1 用户登录

**接口说明**：用户登录验证，支持用户名/邮箱+密码的方式登录

**请求路径**：`/auth/login`

**请求方式**：`POST`

**请求参数**：
```json
{
  "username": "string",        // 用户名或邮箱，必填
  "password": "string",        // 密码，必填
  "remember": false,           // 是否记住登录，可选，默认false
  "deviceType": "web",         // 设备类型，可选，默认web
  "deviceId": "string"         // 设备标识，可选
}
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "登录成功",            // 状态描述
  "data": {
    "user": {
      "id": 1,                          // 用户ID
      "username": "qianhu",             // 用户名
      "email": "qianhu@example.com",    // 邮箱
      "nickname": "薯条",                // 昵称
      "avatar": "https://...",          // 头像URL
      "phone": "13800138000",           // 手机号
      "gender": 1,                      // 性别
      "emailVerified": true             // 邮箱是否已验证
    },
    "token": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 访问令牌
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 刷新令牌
      "expiresIn": 7200,                // 令牌有效期（秒）
      "tokenType": "Bearer"             // 令牌类型
    }
  }
}
```

### 2.2 用户注册

**接口说明**：新用户注册，创建用户账户

**请求路径**：`/auth/register`

**请求方式**：`POST`

**请求参数**：
```json
{
  "username": "string",        // 用户名，必填，3-20字符
  "email": "string",           // 邮箱地址，必填
  "password": "string",        // 密码，必填，至少8位且符合复杂度要求
  "confirmPassword": "string", // 确认密码，必填，需与password一致
  "agreeTerms": true,          // 是否同意服务条款，必填，必须为true
  "deviceType": "web",         // 设备类型，可选，默认web
  "deviceId": "string"         // 设备标识，可选
}
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "注册成功",            // 状态描述
  "data": {
    "user": {
      "id": 2,                          // 用户ID
      "username": "newuser",            // 用户名
      "email": "newuser@example.com",   // 邮箱
      "nickname": "新用户",              // 昵称（默认为用户名）
      "emailVerified": false            // 邮箱验证状态
    },
    "token": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 访问令牌
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 刷新令牌
      "expiresIn": 7200,                // 令牌有效期（秒）
      "tokenType": "Bearer"             // 令牌类型
    }
  }
}
```

### 2.3 发送邮箱验证码

**接口说明**：发送邮箱验证码，用于密码重置、邮箱验证等场景

**请求路径**：`/auth/sendVerificationCode`

**请求方式**：`POST`

**请求参数**：
```json
{
  "email": "string",           // 邮箱地址，必填
  "verificationType": 2        // 验证类型，必填，1-注册验证 2-密码重置 3-登录验证
}
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "验证码发送成功",       // 状态描述
  "data": {
    "email": "user@example.com",       // 邮箱地址
    "expireTime": "2024-01-14 15:30:00", // 验证码过期时间
    "sendCount": 1,                    // 今日发送次数
    "maxSendCount": 10                 // 今日最大发送次数
  }
}
```

### 2.4 验证邮箱验证码

**接口说明**：验证邮箱验证码的有效性

**请求路径**：`/auth/verifyCode`

**请求方式**：`POST`

**请求参数**：
```json
{
  "email": "string",           // 邮箱地址，必填
  "verificationCode": "string", // 验证码，必填，6位数字
  "verificationType": 2        // 验证类型，必填，1-注册验证 2-密码重置 3-登录验证
}
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "验证码验证成功",       // 状态描述
  "data": {
    "verified": true,                  // 验证结果
    "resetToken": "temp_token_123456", // 临时重置令牌（仅密码重置时返回）
    "expiresIn": 600                   // 重置令牌有效期（秒）
  }
}
```

### 2.5 重置密码

**接口说明**：使用验证码重置用户密码

**请求路径**：`/auth/resetPassword`

**请求方式**：`POST`

**请求参数**：
```json
{
  "email": "string",           // 邮箱地址，必填
  "resetToken": "string",      // 重置令牌，必填，从验证码接口获取
  "newPassword": "string",     // 新密码，必填，至少8位且符合复杂度要求
  "confirmPassword": "string"  // 确认密码，必填，需与newPassword一致
}
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "密码重置成功",        // 状态描述
  "data": {
    "success": true,                   // 重置结果
    "message": "密码已成功重置，请使用新密码登录"
  }
}
```

### 2.6 获取用户信息

**接口说明**：获取当前登录用户的详细信息

**请求路径**：`/auth/userInfo`

**请求方式**：`GET`

**请求头**：
```
Authorization: Bearer <access_token>
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "success",            // 状态描述
  "data": {
    "id": 1,                          // 用户ID
    "username": "qianhu",             // 用户名
    "email": "qianhu@example.com",    // 邮箱
    "nickname": "薯条",                // 昵称
    "avatar": "https://...",          // 头像URL
    "phone": "13800138000",           // 手机号
    "gender": 1,                      // 性别
    "birthday": "1990-01-01",         // 生日
    "emailVerified": true,            // 邮箱是否已验证
    "lastLoginTime": "2024-01-14 14:30:00", // 最后登录时间
    "loginCount": 25,                 // 登录次数
    "createDt": "2023-01-01 10:00:00" // 注册时间
  }
}
```

### 2.7 刷新访问令牌

**接口说明**：使用refresh_token刷新access_token

**请求路径**：`/auth/refreshToken`

**请求方式**：`POST`

**请求参数**：
```json
{
  "refreshToken": "string"     // 刷新令牌，必填
}
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "令牌刷新成功",        // 状态描述
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 新的访问令牌
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // 新的刷新令牌
    "expiresIn": 7200,                // 令牌有效期（秒）
    "tokenType": "Bearer"             // 令牌类型
  }
}
```

### 2.8 用户登出

**接口说明**：用户登出，清除会话信息

**请求路径**：`/auth/logout`

**请求方式**：`POST`

**请求头**：
```
Authorization: Bearer <access_token>
```

**请求参数**：
```json
{
  "logoutAll": false           // 是否登出所有设备，可选，默认false
}
```

**响应参数**：
```json
{
  "code": 200,                 // 状态码，200表示成功
  "msg": "登出成功",            // 状态描述
  "data": {
    "success": true,                   // 登出结果
    "message": "已成功登出"
  }
}
```

## 3. 前端接口封装示例

```typescript
// src/services/auth.ts

// 用户登录参数
export interface LoginParams {
  username: string;
  password: string;
  remember?: boolean;
  deviceType?: string;
  deviceId?: string;
}

// 用户注册参数
export interface RegisterParams {
  username: string;
  email: string;
  password: string;
  confirmPassword: string;
  agreeTerms: boolean;
  deviceType?: string;
  deviceId?: string;
}

// 发送验证码参数
export interface SendCodeParams {
  email: string;
  verificationType: number; // 1-注册验证 2-密码重置 3-登录验证
}

// 验证验证码参数
export interface VerifyCodeParams {
  email: string;
  verificationCode: string;
  verificationType: number;
}

// 重置密码参数
export interface ResetPasswordParams {
  email: string;
  resetToken: string;
  newPassword: string;
  confirmPassword: string;
}

// 刷新令牌参数
export interface RefreshTokenParams {
  refreshToken: string;
}

// 用户信息接口
export interface UserInfo {
  id: number;
  username: string;
  email: string;
  nickname: string;
  avatar: string;
  phone: string;
  gender: number;
  birthday: string;
  emailVerified: boolean;
  lastLoginTime: string;
  loginCount: number;
  createDt: string;
}

// 令牌信息接口
export interface TokenInfo {
  accessToken: string;
  refreshToken: string;
  expiresIn: number;
  tokenType: string;
}

// 登录响应接口
export interface LoginResponse {
  user: UserInfo;
  token: TokenInfo;
}

// 用户登录
export function login(params: LoginParams) {
  return request<LoginResponse>({
    url: '/auth/login',
    method: 'post',
    data: params
  });
}

// 用户注册
export function register(params: RegisterParams) {
  return request<LoginResponse>({
    url: '/auth/register',
    method: 'post',
    data: params
  });
}

// 发送验证码
export function sendVerificationCode(params: SendCodeParams) {
  return request({
    url: '/auth/sendVerificationCode',
    method: 'post',
    data: params
  });
}

// 验证验证码
export function verifyCode(params: VerifyCodeParams) {
  return request({
    url: '/auth/verifyCode',
    method: 'post',
    data: params
  });
}

// 重置密码
export function resetPassword(params: ResetPasswordParams) {
  return request({
    url: '/auth/resetPassword',
    method: 'post',
    data: params
  });
}

// 获取用户信息
export function getUserInfo() {
  return request<UserInfo>({
    url: '/auth/userInfo',
    method: 'get'
  });
}

// 刷新令牌
export function refreshToken(params: RefreshTokenParams) {
  return request<TokenInfo>({
    url: '/auth/refreshToken',
    method: 'post',
    data: params
  });
}

// 用户登出
export function logout(logoutAll: boolean = false) {
  return request({
    url: '/auth/logout',
    method: 'post',
    data: { logoutAll }
  });
}
```

## 4. 密码复杂度规则

### 4.1 密码要求
- 最少8个字符
- 至少包含一个大写字母（A-Z）
- 至少包含一个小写字母（a-z）
- 至少包含一个数字（0-9）
- 至少包含一个特殊字符（!@#$%^&*()_+-=[]{}|;:,.<>?）

### 4.2 前端验证正则表达式
```javascript
// 密码复杂度验证
const passwordValidation = {
  length: (password) => password.length >= 8,
  uppercase: (password) => /[A-Z]/.test(password),
  lowercase: (password) => /[a-z]/.test(password),
  number: (password) => /\d/.test(password),
  special: (password) => /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
};

// 邮箱格式验证
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

// 用户名格式验证（3-20字符，字母数字下划线）
const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
```

## 5. 错误码定义

| 错误码 | 描述 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（令牌无效或过期） |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 409 | 资源冲突（如用户名/邮箱已存在） |
| 429 | 请求过于频繁 |
| 500 | 服务器内部错误 |

### 5.1 详细错误码

| 错误码 | 错误类型 | 描述 |
|--------|----------|------|
| 40001 | LOGIN_FAILED | 用户名或密码错误 |
| 40002 | USER_NOT_FOUND | 用户不存在 |
| 40003 | USER_DISABLED | 用户已被禁用 |
| 40004 | PASSWORD_ERROR | 密码错误 |
| 40005 | EMAIL_NOT_VERIFIED | 邮箱未验证 |
| 40101 | TOKEN_INVALID | 令牌无效 |
| 40102 | TOKEN_EXPIRED | 令牌已过期 |
| 40103 | REFRESH_TOKEN_INVALID | 刷新令牌无效 |
| 40901 | USERNAME_EXISTS | 用户名已存在 |
| 40902 | EMAIL_EXISTS | 邮箱已存在 |
| 40903 | VERIFICATION_CODE_INVALID | 验证码无效或已过期 |
| 40904 | VERIFICATION_CODE_USED | 验证码已使用 |
| 42901 | SEND_CODE_FREQUENTLY | 发送验证码过于频繁 |
| 42902 | SEND_CODE_LIMIT | 超出每日发送限制 |

## 6. 安全策略建议

### 6.1 密码安全
- 使用bcrypt或类似算法进行密码哈希
- 为每个密码生成唯一的盐值
- 密码错误次数限制（连续5次错误锁定30分钟）

### 6.2 令牌安全
- 使用JWT令牌，设置合理的过期时间
- 访问令牌有效期：2小时
- 刷新令牌有效期：7天
- 支持令牌撤销机制

### 6.3 验证码安全
- 验证码有效期：10分钟
- 每日发送次数限制：10次
- 发送间隔限制：60秒
- 验证码使用后立即失效

### 6.4 接口安全
- 实现请求频率限制
- 添加IP地址记录和异常检测
- 敏感操作需要二次验证
- 所有接口使用HTTPS

## 7. 接口实现建议

### 7.1 技术栈推荐
- **后端框架**：Spring Boot 2.7+
- **安全框架**：Spring Security + JWT
- **数据库**：MySQL 8.0+
- **ORM框架**：Mybatis-Plus
- **缓存**：Redis（存储验证码、会话信息）
- **邮件服务**：Spring Boot Mail + 第三方邮件服务

### 7.2 关键实现要点
1. 统一响应格式和异常处理
2. 接口参数校验和数据脱敏
3. 操作日志记录和审计
4. 分布式session管理
5. 数据库连接池优化
6. 接口监控和告警机制

### 7.3 部署建议
- 使用Docker容器化部署
- 配置负载均衡和高可用
- 定期备份用户数据
- 实施SSL证书和HTTPS
- 配置防火墙和入侵检测
